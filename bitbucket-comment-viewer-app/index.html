<!doctype html>
<html lang="en-US">

<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <title>Gitlens Comment Viewer</title>
  <script src="showdown.min.js"></script>
  <link rel="stylesheet" type="text/css" href="styles.css">
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/highlight.js/latest/styles/github.min.css">
  <script src="bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/highlight.js/latest/highlight.min.js"></script>
  <style>
    .mention {
      background-color: #1B49A0;
      color: #FFFFFF;
      padding: 5px;
      border-radius: 7px;
      text-decoration: none;
      font-weight: normal;
    }
    .mention:hover {
      font-weight: normal;
      color: #FFFFFF;
      text-decoration: none;
    }
  </style>
</head>

<body>
  <div id="buttons-container" class="fixed-top">
    <button id="addBtn" type="button" class="btn btn-outline-secondary float-left" style="margin-left: 20px; margin-top: 10px; margin-bottom: 10px;">Add
      Comment</button>
    <button id="closeBtn" type="button" class="btn btn-outline-danger float-right" style="margin-right: 20px; margin-top: 10px; margin-bottom: 10px;">Close</button>
  </div>
  <div id="spinner" class="spinner">
    <div class="bounce1"></div>
    <div class="bounce2"></div>
    <div class="bounce3"></div>
  </div>
  <div id="w">
    <div id="container">
      <ul id="comments">
      </ul>
    </div>
  </div>
  <script>
    // var converter = new showdown.Converter();

    const logger = require('electron').remote.require('./logger');

    require('./renderer.js');
    const { ipcRenderer } = require('electron');
    // a map for comments
    // [key: CommentID, value: CommentObject]
    var commentsMap = new Map();
    let nonReplyCount = 0;
    let scrollToIndex;

    function reply(data) {
      let commentID = data.getAttribute('commentID');
      let comment = commentsMap[commentID];
      ipcRenderer.send('reply.comment',
        {
          Id: comment.Id,
          Line: comment.Line,
          Path: comment.Path,
          Message: comment.Message,
          Commit: comment.Commit
        }
      );
    }

    function edit(data) {
      let commentID = data.getAttribute('commentID');
      let comment = commentsMap[commentID];
      ipcRenderer.send('edit.comment', {
        Id: comment.Id,
        Line: comment.Line,
        Path: comment.Path,
        Message: comment.Message,
        Commit: comment.Commit
      }
      );
    }

    function del(data) {
      let commentID = data.getAttribute('commentID');
      let comment = commentsMap[commentID];
      if (window.confirm('Are you sure to delete this comment?')) {
        ipcRenderer.send('delete.comment', {
          Id: comment.Id,
          Line: comment.Line,
          Path: comment.Path,
          Message: comment.Message,
          Commit: comment.Commit
        });
      }
    }

    var showdown = require('showdown');
    !function(){"use strict";var a=function(){return[{type:"output",regex:"<a(.*?)>",replace:function(a,b){return'<a target="_blank"'+b+">"}}]};"undefined"!=typeof window&&window.showdown&&window.showdown.extensions&&window.showdown.extension("targetblank",a),"undefined"!=typeof module&&(module.exports=a)}();
    var converter = new showdown.Converter({extensions: ['targetblank']});
    var commentUl = document.getElementById('comments');

    function linkText(text) {
        // set up the URL prefixes that you want to use for the links
        const profilePrefix = 'https://bitbucket.org/';

        // regexes to detect mentions and/or hashtagsâ€¦
        // this might differ in your site, and I'm sure there's more thorough examples available on the web
        // (or you could try find Twitter's implementation)
        const mentionRegex = /(^|\W)@([\w.-]+)($|[^\w.-])/g;

        let linkedText = text.replace(mentionRegex, `$1 **<a class="mention" target="_blank" href="${profilePrefix}$2">@$2</a>** $3`);
        return linkedText;
    }

    function render(comments, ul) {
      for (var i = 0; i < comments.length; i++) {
        var comment = comments[i];
        commentsMap[comment.Id] = comment;

        var item = document.createElement('li');
        item.className = 'cmmnt';
        if (!comment.ParentId) {
          item.id = `comment-${++nonReplyCount}`;
        }

        var avatarDiv = document.createElement('div');
        avatarDiv.className = 'avatar';
        avatarDiv.innerHTML = `<a href="javascript:void(0);"><img src="images/default.png" width="40" height="40" alt="default avatar"></a>`;
        item.appendChild(avatarDiv);

        var contentDiv = document.createElement('div');
        contentDiv.className = 'cmmnt-content';
        contentDiv.innerHTML =
          `<header><a href="javascript:void(0);" class="userlink">${comment.Name}</a></header>
        ${converter.makeHtml(linkText(comment.Message))}
          <footer><a href="#!" commentId="${comment.Id}" onclick="reply(this);" class="userlink">Reply</a> &nbsp&nbsp <a href="#!" commentId="${comment.Id}" onclick="edit(this);" class="userlink">Edit</a>  &nbsp&nbsp <a href="#!" commentId="${comment.Id}" onclick="del(this);" class="userlink">Delete</a></footer>`;
        item.appendChild(contentDiv);

        if (comment.Replies && comment.Replies.length > 0) {
          var repliesUl = document.createElement('ul');
          repliesUl.className = 'replies';
          render(comment.Replies, repliesUl);
          item.appendChild(repliesUl);
        }

        ul.appendChild(item);
      }

      var allPre, i, j;
      allPre = document.getElementsByTagName("pre");
      for (i = 0, j = allPre.length; i < j; i++) {
        hljs.highlightBlock(allPre[i]);
      }
    }

    // send ui.ready message to main process when the window loaded
    window.addEventListener('load', function () {
      ipcRenderer.send('ui.ready');
    })

    // init the editor with the incoming value
    ipcRenderer.on('init.editor', function (event, arg) {
      commentUl.innerHTML = '';
      nonReplyCount = 0;
      if (arg.length == 0) {
        commentUl.innerText = 'No Comments Found';
      }
      else render(arg, commentUl);

      document.getElementById('spinner').style.display = 'none';
      document.getElementById('w').style.display = 'block';

      let lastComment = document.getElementById(`comment-${scrollToIndex}`);
      lastComment.scrollIntoView({behavior: "smooth", block: "start", inline: "nearest"});
    })

    var addBtn = document.getElementById('addBtn');
    var closeBtn = document.getElementById('closeBtn');

    addBtn.addEventListener('click', function () {
      scrollToIndex = nonReplyCount + 1;
      ipcRenderer.send('add.comment');
    })
    closeBtn.addEventListener('click', function () {
      ipcRenderer.send('close');
    })

  </script>
</body>

</html>
